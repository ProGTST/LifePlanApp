# タグ画面 仕様書

## 1. 画面基本情報

| 項目 | 内容 |
|------|------|
| 画面ID | tag |
| 画面名 | タグ |
| URL | N/A（SPA。ビューID: `tag`） |
| 対象ユーザー | ログイン済みの一般ユーザー（全員が共通のタグマスタを編集可能） |
| 関連画面 | **遷移元**: サイドバー「タグ」。**遷移先**: 他画面。収支記録・収支履歴でタグを選択する際のマスタ。 |

---

## 2. 画面概要

- **目的**: 収支に付与するタグのマスタ（TAG）を登録・編集・削除する。一覧でドラッグにより表示順を変更できる。
- **業務上の位置付け**: タグマスタの一覧・追加・更新・削除画面。収支とタグの対応は TAG_MANAGEMENT で別管理。
- **想定利用シナリオ**: 「食費」「交通費」「娯楽」などタグを登録し、収支記録時に複数タグを付与する。

---

## 3. UI構成

### 3.1 画面レイアウト

| エリア | 内容 |
|--------|------|
| ヘッダー | タイトル「タグ」、データ最新化、追加ボタン、削除モード切替 |
| 検索エリア | なし |
| 一覧エリア | tag-table（ドラッグ、アイコン、タグ名、削除） |
| 詳細エリア | 追加時のみモーダル（タグ名、色・アイコン） |
| フッター | 戻るボタン |

### 3.2 入力項目定義（追加モーダル）

| 項目名 | DB項目 | 型 | 必須 | 制約 | 備考 |
|--------|--------|-----|------|------|------|
| タグ名 | TAG.TAG_NAME | 文字列 | ○ | — | 例: 食費, 娯楽 |
| 色 | TAG.COLOR | 文字列 | — | #rrggbb 推奨 | カラーピッカー |
| アイコンパス | TAG.ICON_PATH | 文字列 | — | — | ピッカーで選択 |

一覧行: タグ名（contentEditable）、アイコン（クリックで色・アイコン変更）、削除（削除モード時のみ表示）。

---

## 4. 操作仕様（イベント仕様）

| 操作 | 条件 | 処理内容 | 備考 |
|------|------|----------|------|
| 追加ボタン | — | モーダルを開く。フォームを初期化（名前空、色デフォルト） | |
| モーダル 登録 | タグ名が空でない | 新規 TAG 行（ID=最大+1, SORT_ORDER=最大+1）を追加。saveTagCsvOnly → モーダル閉じ、一覧再描画 | |
| タグ名セル編集 | — | 空なら deleteTagRow。否则 saveTagNameFromCell（バージョンチェック → TAG_NAME 更新 → persistTag） | |
| アイコンクリック | — | カラーピッカー。バージョンチェック → COLOR, ICON_PATH 更新 → persistTag | |
| ドラッグ並び替え | — | moveTagOrder: SORT_ORDER 再採番 → persistTag | |
| 行削除 | 削除モード ON | deleteTagRow: 該当行削除 → saveTagCsvOnly | |

---

## 5. 業務ルール

- **タグマスタはユーザー共通**: ログイン済みユーザーは全員が一覧の編集・追加・削除が可能（USER_ID による制限なし）。
- **表示順**: SORT_ORDER 昇順。ドラッグで並び替えた際に SORT_ORDER を 0 から再採番する。
- **楽観的ロック**: 更新・削除前に TAG の VERSION をチェック。不一致時はアラート後に再取得・再描画。
- **タグ削除と TAG_MANAGEMENT**: タグ行を削除しても TAG_MANAGEMENT の当該 TAG_ID は本画面では削除しない（収支側で参照切れになる可能性は別仕様で考慮）。

---

## 6. データ連携

### 6.1 API仕様

| メソッド | パス | 概要 |
|----------|------|------|
| GET | /api/data/TAG.csv | タグ一覧取得 |
| POST | /api/data/TAG.csv | タグ CSV 保存（saveTagCsvOnly。行あり時のみ） |

### 6.2 DB定義（CSV 対応）

| 種別 | テーブル（ファイル） | 備考 |
|------|----------------------|------|
| 使用テーブル | TAG | 全件取得。SORT_ORDER 昇順で表示 |
| 参照テーブル | TAG | 同上 |
| 更新対象 | TAG | 追加・更新（TAG_NAME, COLOR, ICON_PATH, SORT_ORDER）・削除 |

---

## 7. 権限制御

- タグマスタは**ユーザー共通**。特別な権限区分はなし。

---

## 8. バリデーション仕様

| 種別 | 内容 |
|------|------|
| 必須チェック | タグ名: 追加時は空不可。一覧で空にした場合は削除扱い |

---

## 9. エラー仕様

| 項目 | 内容 |
|------|------|
| 表示位置 | バージョン競合: alert。API 失敗: console.error |
| メッセージ内容 | getVersionConflictMessage と同様 |
| HTTP ステータス | POST が 200 以外のとき saveCsvViaApi が throw |

---

## 10. 非機能要件

| 項目 | 内容 |
|------|------|
| レスポンス目標 | 特になし |
| 同時接続数想定 | 特になし |
| ログ出力内容 | 特になし |
