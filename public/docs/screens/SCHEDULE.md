# スケジュール画面 仕様書

## 1. 画面基本情報

| 項目 | 内容 |
|------|------|
| 画面ID | schedule |
| 画面名 | スケジュール |
| URL | N/A（SPA。ビューID: `schedule`） |
| 対象ユーザー | ログイン済みの一般ユーザー。参照可能な勘定に紐づく取引のみ表示。 |
| 関連画面 | **遷移元**: フッター「スケジュール」、サイドバー「スケジュール」。**遷移先**: 収支記録（行クリックで編集）、他画面。検索条件は filterStateSchedule で保持（収支履歴・カレンダーとは別）。 |

---

## 2. 画面概要

- **目的**: 収支（予定・実績）を日単位・週単位・月単位のタイムラインで表示し、検索条件で絞り込む。行クリックで収支記録画面に遷移して編集できる。
- **業務上の位置付け**: 収支データのスケジュールビュー。カレンダーと同様に検索条件を別保持し、予定と実績を両方表示する（getFilteredTransactionListForSchedule）。
- **想定利用シナリオ**: 日/週/月の列でいつ何があるかを俯瞰し、クリックして詳細を編集する。

---

## 3. UI構成

### 3.1 画面レイアウト

| エリア | 内容 |
|--------|------|
| ヘッダー | タイトル「スケジュール」、データ最新化、検索条件リセット |
| 検索エリア | 収支履歴と同様の検索条件（予定/実績、種別、**日付欄は非表示**、カテゴリ、タグ、勘定、金額、フリーテキスト）。filterStateSchedule で保持。updateTransactionHistoryTabLayout で currentView が schedule のときは日付行を非表示（transaction-history-search-row--hidden） |
| 一覧エリア | 日/週/月の単位切替。**固定列 6 列**（種類・カテゴリ・取引名・金額・取引日・状況）＋**日付列**（単位ごとに幅: 日 45px、週 75px、月 43px）。開始日・過去・未来の月数で表示範囲を制御。縦仮想スクロールで表示行のみ描画。 |
| 集計エリア | 表示中データの予定収入・予定支出・予定残高、実績収入・実績支出・実績残高、進捗率(収入)・進捗率(支出)・進捗率(残高)。金額・進捗率は条件により赤/青で表示 |
| 詳細エリア | 行クリックで収支記録画面へ遷移。取引日列クリックで取引予定日ポップアップ、状況列（進行中・完了時）クリックで取引実績照会ポップアップ |
| フッター | 共通ナビ |

### 3.2 取引予定日ポップアップ・取引実績照会ポップアップ

- **取引予定日ポップアップ**（取引日列クリックで表示）
  - タイトル: 「取引予定日：取引名」（取引名がない場合は「取引予定日」のみ）。
  - 上部: 頻度・間隔を一ブロック、繰り返し（ラベル＋登録内容）を一ブロックで縦並び表示。
  - 中央: 対象日一覧（planOccurrence で算出した発生日を YYYY/MM/DD 形式でリスト表示）。
  - 下部: 閉じるボタン（中央寄せ）。モーダル最大高さは 65vh。
- **取引実績照会ポップアップ**（状況列「進行中」または「完了」クリックで表示）
  - タイトル: 「取引実績：取引名」。
  - 一覧: 取引日・カテゴリ(アイコン)・取引名・金額。表ヘッダーはスクロール時も固定。閉じるボタンは中央寄せ。

### 3.3 検索条件の表示・日付抽出

- **検索条件の日付欄**: スケジュール画面では検索条件フォームの日付欄（開始日・終了日）を**非表示**にする（updateTransactionHistoryTabLayout。カレンダー同様）。表示範囲はスケジュールの「開始日」「過去・未来の月数」で制御する。
- **入力項目定義**: 収支履歴画面の検索条件と同様。ただし**スケジュール画面では検索条件フォームの日付欄は非表示**（カレンダー同様、updateTransactionHistoryTabLayout で日付行を隠す）。スケジュールでは filterStatus は常に ["plan", "actual"] で固定（getFilteredTransactionListForSchedule で plan と actual の両方を使用）。日付で絞る場合は filterDateFrom / filterDateTo が使われるが、UI 上は日付欄を出さず、表示範囲はツールバーの開始日・過去/未来月で制御する想定。
- **予定取引の日付抽出**: 検索条件の日付範囲で予定を絞り込む場合は、**予定発生日**（getPlanOccurrenceDates で算出。完了予定日は考慮しない）のいずれかが範囲内に含まれる予定のみ抽出する（transactionDataFilter.applyFilters）。

### 3.4 実装上の補足

| 項目 | 内容 |
|------|------|
| **縦方向仮想スクロール** | `schedule-spacer`（上余白）と `schedule-visible`（表示行コンテナ）で行の表示域を制御。`updateVisibleRows()` で表示範囲（`lastVisibleRange`）を更新し、見えている行のみ DOM を描画。スクロールは 1 フレームあたり 1 回更新のスロットル、`{ passive: true }` 指定。 |
| **実績線（Canvas）** | `schedule-connector-canvas` に `drawScheduleConnectorCanvas()` で描画。隣接する実績アイコン間のみ線を引き、途中にアイコンがある場合は描画しない。固定列上には描画せず spacer 内でスクロール時に位置調整。 |
| **Fire アイコン優先** | 遅れセルでは「実」アイコンを表示せず、fire アイコンのみ表示する。 |
| **固定列** | 種類・カテゴリ・取引名・金額・取引日・状況の 6 列を `position: sticky` で固定。横スクロール時も左側に固定表示。 |
| **日付列の幅** | 日単位 45px、週単位 75px、月単位 43px。 |

---

## 4. 操作仕様（イベント仕様）

| 操作 | 条件 | 処理内容 | 備考 |
|------|------|----------|------|
| 単位切替（日/週/月） | — | 列ヘッダーと列内容を再計算・再描画。日単位は日付列、週単位は週の開始日等、月単位は月でグループ | |
| 検索条件変更 | — | filterStateSchedule を更新し、表示を再描画。registerFilterChangeCallback で他コールバックも実行 | |
| 検索条件リセット | — | 条件をデフォルトに戻して再描画 | |
| 行クリック（種類・取引名・日付セル） | — | 該当取引の ID を setTransactionEntryEditId にセットし、収支記録画面へ遷移 | |
| 取引日列クリック | — | 取引予定日ポップアップを表示（頻度・間隔・繰り返し・対象日一覧、閉じる）。タイトルは「取引予定日：取引名」 | |
| 状況列クリック | 進行中または完了（実績あり）のとき | 取引実績照会ポップアップを表示（取引実績：取引名、取引日・カテゴリ(アイコン)・取引名・金額の一覧、ヘッダー固定、閉じるボタン中央） | 中止・未着のときはボタンラベルのみ |
| ナビ（前後） | — | 表示範囲の日付を前後にシフトして再描画 | |
| データ最新化 | — | loadTransactionData(true) のうえでスケジュールを再描画 | |

---

## 5. 業務ルール

- **表示対象**: 収支履歴と同様に、削除フラグ・勘定の参照権限・検索条件で絞り込んだ取引。予定と実績を両方表示（filterStatus は schedule 用で plan+actual 固定）。**予定取引の日付による抽出**: 検索条件の日付範囲がある場合、予定は**予定発生日**（getPlanOccurrenceDates。完了予定日は考慮しない）のいずれかが範囲内にあるもののみ抽出（transactionDataFilter.applyFilters）。予定取引の日付条件は予定発生日（getPlanOccurrenceDates）で判定する。
- **日付範囲**: 日単位は 1 日ごとの列、週単位は週の開始日（日曜）ごと、月単位は月ごとの列。表示範囲は過去・未来の月数で制御。
- **ソート・集計**: 列ごとに該当する取引を日付範囲でフィルタして表示。取引は TRANDATE_FROM～TRANDATE_TO が列の範囲と重なるものを表示。
- **集計ビュー（予定・実績・進捗率）**
  - **予定収入・予定支出**: 表示中の予定行について、種類が収入/支出の行ごとに「予定金額 × 対象日の日数」を計算し合計する。対象日の日数は planOccurrence（getPlanOccurrenceDates）により、頻度（1日/日ごと/週ごと/月ごと/年ごと）・間隔・繰り返しに従って取引期間内の発生日数を算出する。
  - **予定残高**: 予定収入 － 予定支出。
  - **実績収入・実績支出・実績残高**: 表示中の予定に紐づく実績取引の合計（重複は ID 単位で除外）。実績残高 ＝ 実績収入 － 実績支出。
  - **進捗率(収入)**: 実績収入 ÷ 予定収入 × 100（予定収入が 0 のときは「—」）。
  - **進捗率(支出)**: （予定支出 － 実績支出）÷ 予定支出 × 100（予定支出が 0 のときは「—」）。
  - **進捗率(残高)**: 実績残高 ÷ 予定残高 × 100（予定残高が 0 のときは「—」）。
  - **文字色**: 予定残高がマイナスのとき予定残高を赤。進捗率(収入)が 50% 以下で実績収入・進捗率(収入)を赤、101% 以上で青。進捗率(支出)・進捗率(残高)も同様（50% 以下で赤、101% 以上で青）。

---

## 6. データ連携

### 6.1 API仕様

収支履歴画面と同様。GET /api/data/*.csv で TRANSACTION, CATEGORY, ACCOUNT, ACCOUNT_PERMISSION, TAG, TRANSACTION_TAG 等を取得。本画面では CSV の更新は行わない。

### 6.2 DB定義（CSV 対応）

| 種別 | テーブル（ファイル） | 備考 |
|------|----------------------|------|
| 使用テーブル | TRANSACTION, CATEGORY, ACCOUNT, ACCOUNT_PERMISSION, TAG, TRANSACTION_TAG 等 | 表示・検索のみ |
| 参照テーブル | 同上 | 更新対象なし |
| 更新対象 | なし | 収支記録画面で更新 |

---

## 7. 権限制御

- 収支履歴と同様。参照可能な勘定に紐づく取引のみ表示。行の権限（参照/編集）は getRowPermissionType で判定し、収支記録画面での編集可否に利用。

---

## 8. バリデーション仕様

- 検索条件の日付・金額は入力されていればフィルタに使用。不正値は無視。

---

## 9. エラー仕様

- 収支履歴と同様。CSV 取得失敗時は空表示。API エラーは未ハンドリング時はコンソール。

---

## 10. 非機能要件

| 項目 | 内容 |
|------|------|
| レスポンス目標 | 特になし |
| 同時接続数想定 | 特になし |
| ログ出力内容 | 特になし |
