# 収支記録画面 仕様書

## 1. 画面基本情報


| 項目     | 内容                                                                 |
| ------ | ------------------------------------------------------------------ |
| 画面ID   | transaction-entry                                                  |
| 画面名    | 収支記録                                                               |
| URL    | N/A（SPA。ビューID: `transaction-entry`）                                |
| 対象ユーザー | ログイン済みの一般ユーザー。参照可能な勘定に紐づく取引の参照・編集、自分の勘定に対する新規登録・編集・削除。             |
| 関連画面   | **遷移元**: フッター「収支記録」、収支履歴の行クリック（編集/閲覧）。**遷移先**: 収支履歴（保存後やキャンセルで戻る）。 |


---

## 2. 画面概要

- **目的**: 収支（予定・実績）の新規登録・編集・削除を行う。取引種別・予定/実績・日付・カテゴリ・勘定・金額・タグ・メモ・予定の繰り返し条件等を入力する。
- **業務上の位置付け**: 収支データの登録・更新のメイン画面。実績登録時は勘定残高（ACCOUNT.BALANCE）と ACCOUNT_HISTORY を更新する。
- **想定利用シナリオ**: 日々の支出を実績で登録する。予定として給与や家賃の繰り返しを登録する。収支履歴から行を選んで編集・削除する。

---

## 3. UI構成

### 3.1 画面レイアウト


| エリア   | 内容                                                                     |
| ----- | ---------------------------------------------------------------------- |
| ヘッダー  | タイトル「収支記録」、保存（登録/更新）ボタン、リセット、削除（編集時）                                   |
| 検索エリア | なし                                                                     |
| 一覧エリア | なし                                                                     |
| 詳細エリア | 収支記録フォーム（取引種別、予定/実績、取引日、カテゴリー、項目名、出金元/入金先、タグ、金額、メモ、予定の場合は繰り返し条件・予定状況等） |
| フッター  | 共通ナビ                                                                   |


### 3.2 入力項目定義


| 項目名     | DB項目                         | 型   | 必須   | 制約                              | 備考                             |
| ------- | ---------------------------- | --- | ---- | ------------------------------- | ------------------------------ |
| 取引種別    | TRANSACTION.TRANSACTION_TYPE | 列挙  | ○    | income / expense / transfer     | 収入・支出・振替                       |
| 予定/実績   | TRANSACTION.PROJECT_TYPE     | 列挙  | ○    | plan / actual                   | 実績時は取引日は1日のみ（TRANDATE_FROM=TO） |
| 取引日（開始） | TRANSACTION.TRANDATE_FROM    | 日付  | ○    | YYYY-MM-DD                      | 実績は単日                          |
| 取引日（終了） | TRANSACTION.TRANDATE_TO      | 日付  | —    | YYYY-MM-DD                      | 予定のみ。実績は FROM と同一              |
| カテゴリー   | TRANSACTION.CATEGORY_ID      | 文字列 | ○    | CATEGORY.ID                     | 種別に応じたカテゴリのみ選択可                |
| 項目名     | TRANSACTION.NAME             | 文字列 | ○    | —                               | 例: 給与, スーパー                    |
| 出金元     | TRANSACTION.ACCOUNT_ID_OUT   | 文字列 | 条件付き | ACCOUNT.ID                      | 支出・振替時必須                       |
| 入金先     | TRANSACTION.ACCOUNT_ID_IN    | 文字列 | 条件付き | ACCOUNT.ID                      | 収入・振替時必須                       |
| タグ      | TAG_MANAGEMENT               | 複数  | —    | TAG.ID                          | 複数選択。TAG_MANAGEMENT で紐付け       |
| 金額      | TRANSACTION.AMOUNT           | 数値  | ○    | —                               | 単位はアプリで統一（円等）                  |
| メモ      | TRANSACTION.MEMO             | 文字列 | —    | —                               | 任意                             |
| 頻度      | TRANSACTION.FREQUENCY        | 列挙  | 予定時  | day/daily/weekly/monthly/yearly | 繰り返し予定用                        |
| 間隔      | TRANSACTION.INTERVAL         | 数値  | —    | 1以上（dayは0）                      | 2週間ごと→2等                       |
| 繰り返し単位  | TRANSACTION.CYCLE_UNIT       | 文字列 | —    | 週: SU,MO,… 月: 1～31,-1等 年: MMDD  | 予定の曜日・日付指定                     |
| 予定状況    | TRANSACTION.PLAN_STATUS      | 列挙  | 予定時  | planning/complete/canceled      | 予定のみ                           |


### 3.3 タグ選択画面（モーダル）

収支記録フォーム内の「タグを選択」ボタンで開くオーバーレイです。当該取引に付与するタグを複数選択する。

| 項目 | 内容 |
|------|------|
| トリガー | 「タグを選択」ボタン（id: transaction-entry-tag-open-btn 等）押下 |
| 表示データ | **TAG.csv を全件取得**し、SORT_ORDER 順で一覧表示。参照権限による絞り込みはなし（タグマスタは全ユーザー共通）。 |
| UI | モーダル内にタグ一覧（チェックボックス風）。各タグは ID・名称・色等を表示。既に選択中のタグはチェック済みで表示。 |
| 操作 | 「全解除」で選択をクリア、「設定」で選択結果をフォームに反映してモーダルを閉じる。オーバーレイ外クリックで閉じる。 |
| 反映 | 選択した TAG_ID の集合が、保存時に TAG_MANAGEMENT に TRANSACTION_ID と紐付けて登録される（既存紐付けは上書き）。 |

---

### 3.4 実績選択画面（モーダル）

収支記録で**予定**を編集中に、「実績」欄の「実績を選択」ボタンで開くオーバーレイです。当該予定に紐づける取引実績を複数選択する。

| 項目 | 内容 |
|------|------|
| 表示条件 | 予定/実績が「予定」のときのみ実績欄が表示され、「実績を選択」で本モーダルを開ける。 |
| トリガー | 「実績を選択」ボタン押下（id: transaction-entry-actual-open-btn 等） |
| 表示データの検索条件 | 以下をすべて満たす取引のみ対象。<br>・**TRANSACTION.csv を取得し、未削除（DLT_FLG≠1）のみ**に絞ったうえで、<br>・**参照可能な勘定**に紐づく取引（ACCOUNT_ID_IN または ACCOUNT_ID_OUT が、自分の勘定または ACCOUNT_PERMISSION で付与された勘定に含まれる）、<br>・**PROJECT_TYPE = actual**、<br>・**TRANSACTION_TYPE** が編集中の予定の種別（収入/支出/振替）と一致、<br>・**編集中の取引自身は除外**（editingTransactionId と一致する ID は候補から外す）。 |
| 表示 | 上記で得た実績一覧を**週単位**で絞り込み表示。初期表示週は「予定の開始日」（未入力時は今日）が含まれる週（月曜～日曜）。週を切り替えると、その週に TRANDATE_FROM が含まれる実績のみ表示。各実績はカテゴリーアイコン・取引名・日付・金額を表示。 |
| 操作 | 一覧の各行でチェックして選択。「設定」で選択結果をフォームの実績欄に反映し、モーダルを閉じる。週を切り替えると、他週で選択した ID は維持したまま、表示中の週の選択状態が保存される。 |
| 反映 | 選択した実績 ID の集合が、保存時に TRANSACTION_MANAGEMENT に TRAN_PLAN_ID（編集中の予定 ID）と TRAN_ACTUAL_ID の組み合わせで登録される。1実績は1予定にのみ紐づく制約は DATA_CSV 仕様に従う。 |

---

## 4. 操作仕様（イベント仕様）


| 操作      | 条件                  | 処理内容                                                                                                                                   | 備考                           |
| ------- | ------------------- | -------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------- |
| 保存ボタン押下 | 必須項目OK、バージョン一致（編集時） | 新規: TRANSACTION に追加、TAG_MANAGEMENT 更新、実績時は ACCOUNT 残高・ACCOUNT_HISTORY 更新。編集: 同様に TRANSACTION 更新、タグ・紐付け・残高を整合。POST /api/data で各 CSV を保存 | トランザクション制御はアプリ側で複数 CSV を順次保存 |
| リセット    | —                   | フォームを初期状態に戻す（新規時は空、編集時は取得データに戻す）                                                                                                       |                              |
| 削除ボタン   | 編集時、該当行が自分の権限で削除可   | 論理削除（DLT_FLG=1）または物理削除。実績の場合は勘定残高を戻し ACCOUNT_HISTORY に delete を記録。TRANSACTION.csv 等を保存                                                 | バージョンチェックあり                  |
| 取引種別変更  | —                   | カテゴリ・勘定の選択肢を種別に合わせて更新。出金元/入金先の表示を切替                                                                                                    |                              |
| 予定/実績切替 | —                   | 取引終了日を非表示または同一日固定、繰り返し条件の表示/非表示。実績欄の表示・非表示を切り替え。                                                                                               |                              |
| タグを選択    | —                   | タグ選択モーダルを開く。TAG 一覧を表示し、チェックで選択。「設定」でフォームに反映して閉じる。「全解除」で選択クリア。                                                                    | 3.3 タグ選択画面を参照            |
| 実績を選択    | 予定（plan）編集中     | 実績選択モーダルを開く。未削除・参照可能勘定・実績・種別一致の取引を週単位で表示。チェックで選択し「設定」でフォームに反映して閉じる。週切替で表示範囲を変更。                                                          | 3.4 実績選択画面を参照            |


---

## 5. 業務ルール

- **実績の取引日**: 1日のみ。TRANDATE_FROM と TRANDATE_TO を同一日にする。
- **予定の取引日**: 範囲で指定。TRANDATE_FROM ～ TRANDATE_TO。繰り返しは FREQUENCY / INTERVAL / CYCLE_UNIT で指定。
- **勘定の参照権限**: 出金元・入金先に選択できるのは参照可能な勘定のみ。編集権限の有無は収支履歴の行背景等で表示。編集時に対象取引の勘定が参照のみの場合は編集不可とするかは実装に依存。
- **実績登録時の残高**: 支出は出金元勘定の BALANCE を減算、収入は入金先を加算、振替は出金元を減算・入金先を加算。ACCOUNT_HISTORY に当該取引時点の残高を記録する。
- **予定-実績紐付け**: TRANSACTION_MANAGEMENT で TRAN_PLAN_ID と TRAN_ACTUAL_ID を紐付け。1予定に複数実績を紐づけ可能。
- **楽観的ロック**: 編集・削除前に TRANSACTION（および ACCOUNT 等）の VERSION をチェック。不一致時はアラート後に再取得。

---

## 6. データ連携

### 6.1 API仕様


| メソッド | パス                                                                                                                                        | 概要           |
| ---- | ----------------------------------------------------------------------------------------------------------------------------------------- | ------------ |
| GET  | /api/data/TRANSACTION.csv                                                                                                                 | 取引一覧（編集時など）  |
| GET  | /api/data/CATEGORY.csv, ACCOUNT.csv, ACCOUNT_PERMISSION.csv, TAG.csv, TAG_MANAGEMENT.csv, TRANSACTION_MANAGEMENT.csv, ACCOUNT_HISTORY.csv | マスタ・紐付け・残高履歴 |
| POST | /api/data/TRANSACTION.csv                                                                                                                 | 取引 CSV 保存    |
| POST | /api/data/TAG_MANAGEMENT.csv                                                                                                              | タグ紐付け保存      |
| POST | /api/data/TRANSACTION_MANAGEMENT.csv                                                                                                      | 予定-実績紐付け保存   |
| POST | /api/data/ACCOUNT_HISTORY.csv                                                                                                             | 残高履歴保存       |
| POST | /api/data/ACCOUNT.csv                                                                                                                     | 勘定残高更新時      |


### 6.2 DB定義（CSV 対応）


| 種別     | テーブル（ファイル）                                                                                                       | 備考                     |
| ------ | ---------------------------------------------------------------------------------------------------------------- | ---------------------- |
| 使用テーブル | TRANSACTION, CATEGORY, ACCOUNT, ACCOUNT_PERMISSION, TAG, TAG_MANAGEMENT, TRANSACTION_MANAGEMENT, ACCOUNT_HISTORY | フォーム表示・選択肢・紐付け         |
| 参照テーブル | 同上                                                                                                               | 更新時は参照のうえで書き戻し         |
| 更新対象   | TRANSACTION, TAG_MANAGEMENT, TRANSACTION_MANAGEMENT, ACCOUNT_HISTORY, ACCOUNT                                    | 新規・更新・削除に応じて複数 CSV を更新 |


### 6.3 各テーブル更新時のルール・処理条件

保存・削除時にどのテーブルをいつ・どのように更新するかを示す。実行順序は実装に依存するが、残高整合性のため ACCOUNT / ACCOUNT_HISTORY は実績の登録・更新・削除の最後にまとめて反映する想定。

| テーブル（ファイル） | 更新するタイミング | 条件・ルール | 処理内容 |
|----------------------|--------------------|--------------|----------|
| **TRANSACTION** | 保存（新規・編集）・削除 | 常に。新規時は nextId で ID 採番。編集・削除時は対象行の VERSION をチェック。 | **新規**: 1行追加（全項目をフォーム値で設定。DLT_FLG=0）。**編集**: 対象行の項目をフォーム値で上書き（ID は不変。DLT_FLG は既存を維持）。**削除**: 論理削除の場合は当該行の DLT_FLG を 1 にし VERSION をインクリメント。物理削除の場合は行を削除。 |
| **TAG_MANAGEMENT** | 保存（新規・編集） | タグを1つ以上選択していても0個でも実行する。**当該取引（TRANSACTION_ID）に紐づく既存行はすべて削除**したうえで、フォームで選択中の TAG_ID ごとに1行ずつ新規追加。 | 当該 TRANSACTION_ID の既存紐付けを削除し、選択タグ分の (TRANSACTION_ID, TAG_ID) を追加。一意制約 (TRANSACTION_ID, TAG_ID) を満たす。編集時は「その取引のタグ」を丸ごと置き換え。 |
| **TRANSACTION_MANAGEMENT** | 保存（新規・編集）で予定の場合のみ | **PROJECT_TYPE = plan（予定）**のときのみ更新。実績（actual）の新規・編集では当テーブルは触らない。 | **予定の新規・編集**: 当該 TRAN_PLAN_ID に紐づく既存行をすべて削除し、フォームで選択した実績 ID（selectedActualIds）ごとに (TRAN_PLAN_ID, TRAN_ACTUAL_ID) を1行ずつ追加。1実績は1予定にのみ紐づく制約を満たす（同一 TRAN_ACTUAL_ID の重複は登録しない）。予定削除時は当該 TRAN_PLAN_ID の行をすべて削除。 |
| **ACCOUNT** | 実績の登録・更新・削除時のみ | **PROJECT_TYPE = actual（実績）**のときのみ。対象は出金元（ACCOUNT_ID_OUT）・入金先（ACCOUNT_ID_IN）の勘定。 | 支出: 出金元勘定の BALANCE を減算。収入: 入金先勘定の BALANCE を加算。振替: 出金元を減算・入金先を加算。**削除時**は当該取引による変動を逆方向に反映（巻き戻し）。更新時は旧金額と新金額の差を反映。各勘定の VERSION をインクリメントし、監査項目を更新。 |
| **ACCOUNT_HISTORY** | 実績の登録・更新・削除時のみ | **PROJECT_TYPE = actual** のときのみ。当該取引で影響を受ける勘定ごとに、その時点の残高を記録。 | **登録時**: 影響する勘定ごとに1行追加。TRANSACTION_STATUS = `regist`。BALANCE は変動後の残高。**更新時**: 影響する勘定ごとに1行追加。TRANSACTION_STATUS = `update`。**削除時**: 影響する勘定ごとに1行追加。TRANSACTION_STATUS = `delete`。BALANCE は巻き戻し後の残高。ACCOUNT.BALANCE と当該勘定の最新履歴の BALANCE が一致するようにする。 |

- **楽観的ロック**: TRANSACTION / ACCOUNT 等を更新・削除する前に、対象行の VERSION を CSV 上の最新値と比較する。不一致の場合は更新せずアラートし、画面を再取得する。
- **保存順序**: 実装では TRANSACTION → TAG_MANAGEMENT → TRANSACTION_MANAGEMENT の順で保存し、実績の場合は ACCOUNT 残高の計算後に ACCOUNT_HISTORY → ACCOUNT を保存する。

---

## 7. 権限制御

- **勘定の参照権限**: 出金元・入金先に選べる勘定は「自分の勘定」＋「ACCOUNT_PERMISSION で view または edit が付与された勘定」に限定。
- **編集・削除**: 対象取引の勘定が自分所有または edit 権限がある場合にのみ更新・削除可能。参照のみの勘定に紐づく取引は閲覧のみ（実装で setTransactionEntryViewOnly を使用）。

---

## 8. バリデーション仕様


| 種別     | 内容                                                    |
| ------ | ----------------------------------------------------- |
| 必須チェック | 取引種別、予定/実績、取引日（開始）、カテゴリー、項目名、金額。支出・振替時は出金元、収入・振替時は入金先 |
| 桁数・形式  | 金額は数値。日付は YYYY-MM-DD。CYCLE_UNIT は頻度に応じた形式             |
| 日付妥当性  | 実績は開始=終了。予定は開始≦終了                                     |
| 業務チェック | カテゴリは取引種別と一致する TYPE のもののみ選択可                          |


---

## 9. エラー仕様


| 項目         | 内容                                                                 |
| ---------- | ------------------------------------------------------------------ |
| 表示位置       | 必須未入力はフォーカスを当てて処理中断。バージョン競合は alert。API 失敗は throw または catch で表示     |
| メッセージ内容    | バージョン: getVersionConflictMessage。保存失敗: saveCsvViaApi の Error メッセージ |
| HTTP ステータス | POST が 200 以外のとき saveCsvViaApi が throw                             |


---

## 10. 非機能要件


| 項目      | 内容                    |
| ------- | --------------------- |
| レスポンス目標 | 特になし。複数 CSV 保存は順次実行   |
| 同時接続数想定 | 特になし                  |
| ログ出力内容  | 保存失敗時など console.error |


