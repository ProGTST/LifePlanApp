# プロフィール画面 仕様書

## 1. 画面基本情報

| 項目 | 内容 |
|------|------|
| 画面ID | profile |
| 画面名 | プロフィール |
| URL | N/A（SPA。ビューID: `profile`。アプリは `index.html` 内でビュー切替） |
| 対象ユーザー | ログイン済みの一般ユーザー（自分自身のプロフィールのみ編集可能） |
| 関連画面 | **遷移元**: サイドバー「設定」→「プロフィール」、フッター「戻る」で直前画面へ。<br>**遷移先**: サイドバー・フッターから他画面へ。離脱時に `saveUserCsvOnNavigate` で USER.csv を保存。 |

---

## 2. 画面概要

- **目的**: ログインユーザー自身の表示名・アイコン（背景色／画像）を登録・更新する。
- **業務上の位置付け**: ユーザーマスタ（USER）の自己編集画面。ヘッダーのプロフィール表示や他画面での「誰が更新したか」の参照元となる。
- **想定利用シナリオ**: 初回利用時に表示名を設定する。アイコン画像や背景色を変更してアプリ内での自己識別をしやすくする。

---

## 3. UI構成

### 3.1 画面レイアウト

| エリア | 内容 |
|--------|------|
| ヘッダー | メニューバー（タイトル「プロフィール」、データ最新化ボタン）、保存ボタン |
| 検索エリア | なし |
| 一覧エリア | なし |
| 詳細エリア | プロフィールフォーム（アイコン表示、背景色選択、画像選択、デフォルトに戻す、表示名入力） |
| フッター | 戻るボタン |

### 3.2 入力項目定義

| 項目名 | DB項目 | 型 | 必須 | 制約 | 備考 |
|--------|--------|-----|------|------|------|
| 表示名 | USER.NAME | 文字列 | ○ | maxlength 100 | プレースホルダー「表示名を入力」 |
| アイコン背景色 | USER.COLOR | 文字列 | — | #rrggbb 形式推奨 | color 入力＋hex 入力（アクセシビリティ）。無効時はデフォルト色を使用 |
| アイコン画像パス | USER.ICON_PATH | 文字列 | — | — | hidden。ファイル選択または Tauri 保存後のパス。画像優先時は背景色は表示に使わない |

※ 画面では「アイコン表示」「背景色を選択」「画像を選択」「デフォルトに戻す」は操作であり、保存時に NAME / COLOR / ICON_PATH に反映される。

---

## 4. 操作仕様（イベント仕様）

| 操作 | 条件 | 処理内容 | 備考 |
|------|------|----------|------|
| 保存ボタン押下 | 表示名が空でない | バージョンチェック（USER.csv 対象行）→ 該当ユーザー行の NAME/COLOR/ICON_PATH 更新 → USER.csv を API で保存 → clearUserDirty | 表示名未入力時はフォーカスを当てて終了 |
| フォーム submit | 上記同様 | 上記と同様に saveProfileForm を実行 | — |
| 背景色を選択 | — | カラーピッカーを開く。選択色を color/hex に反映し、dirty フラグを立て、アイコン表示を更新 | — |
| 画像を選択 | ファイル選択済み | ブラウザ: Data URL を ICON_PATH にセット。Tauri: save_profile_icon で保存しパスを ICON_PATH にセット。dirty フラグを立て、アイコン表示を更新 | — |
| デフォルトに戻す | — | ICON_PATH をクリア、COLOR をデフォルトに。Tauri かつ既存が /icon/profile/ の場合は delete_profile_icon を呼ぶ。dirty フラグを立て、アイコン表示を更新 | — |
| 表示名 input | — | dirty フラグを立てる。アイコンが画像でない場合は略称表示を更新 | — |
| 画面離脱 | 他画面へ遷移時 | leaveSaveHandlers により saveUserCsvOnNavigate が呼ばれ、フォーム値を userList に反映して USER.csv を保存し clearUserDirty | — |

---

## 5. 業務ルール

- 編集対象は **ログインユーザー（currentUserId）に一致する USER の1行のみ**。他ユーザーの行は編集しない。
- 表示名は **必須**。空では保存しない。
- アイコンは **画像パスが設定されていれば画像を優先**し、未設定の場合は背景色＋表示名先頭4文字の略称を表示する。
- 更新時は **楽観的ロック（VERSION）** を実施。CSV 上の対象行の VERSION と一致する場合のみ更新し、不一致時はアラート表示後に最新データを再取得して画面を再描画する。

---

## 6. データ連携

### 6.1 API仕様

| メソッド | パス | 概要 |
|----------|------|------|
| GET | /api/data/USER.csv | USER.csv 全文取得（fetchCsv → fetchCsvFromApi） |
| POST | /api/data/USER.csv | USER.csv 全文保存。body: `JSON.stringify({ csv })`（saveCsvViaApi） |

※ 本アプリは CSV をファイル単位で読み書き。将来 SQLite 移行時はテーブル単位の CRUD API に置き換え想定。

### 6.2 DB定義（CSV 対応）

| 種別 | テーブル（ファイル） | 備考 |
|------|----------------------|------|
| 使用テーブル | USER | 表示・更新対象。ログインユーザー行のみ編集 |
| 参照テーブル | USER | 同上。全件取得し ID === currentUserId でフィルタ |
| 更新対象 | USER | 該当行の NAME, COLOR, ICON_PATH, 監査項目, VERSION を更新した全体 CSV を保存 |

---

## 7. 権限制御

- **対象ユーザー**: ログイン済みユーザー全員。自分自身のプロフィールのみ編集可能（他ユーザー行は表示・編集しない）。
- 画面表示は **currentUserId に一致する USER 行が存在する前提**。存在しない場合はフォームは空で表示され、保存時は getCurrentUser() が undefined のため保存処理は行わない。

---

## 8. バリデーション仕様

| 種別 | 内容 |
|------|------|
| 必須チェック | 表示名（NAME）: 空は不可。保存時に入力されていなければフォーカスを当てて処理中断 |
| 桁数チェック | 表示名: maxlength 100（HTML 属性） |
| 形式チェック | アイコン背景色: 無効な場合はデフォルト色を使用（#rrggbb でない場合など） |

---

## 9. エラー仕様

| 項目 | 内容 |
|------|------|
| 表示位置 | バージョン競合時: ブラウザ alert。保存 API 失敗時: saveCsvViaApi が throw するため未ハンドリング時はコンソール／未捕捉エラー |
| メッセージ内容 | バージョン不一致: 「他のユーザーが更新しました。最新のデータを取得するので、確認してください。」／データなし: 「他のユーザーが更新しました。該当のデータはありません。」（csvVersionCheck の getVersionConflictMessage） |
| HTTP ステータス | POST /api/data/USER.csv が 200 以外の場合、saveCsvViaApi が res.text() をメッセージに含めて Error を throw |

---

## 10. 非機能要件

| 項目 | 内容 |
|------|------|
| レスポンス目標 | 特になし（CSV 取得・保存は軽量想定）。データ最新化時は cache: reload で再取得 |
| 同時接続数想定 | 特になし |
| ログ出力内容 | 特になし（コンソールエラーは saveProfileForm 内の未捕捉時など） |
