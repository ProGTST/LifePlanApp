# カテゴリー画面 仕様書

## 1. 画面基本情報

| 項目 | 内容 |
|------|------|
| 画面ID | category |
| 画面名 | カテゴリー |
| URL | N/A（SPA。ビューID: `category`） |
| 対象ユーザー | ログイン済みの一般ユーザー（全員が共通のカテゴリマスタを編集可能） |
| 関連画面 | **遷移元**: サイドバー「カテゴリー」。**遷移先**: 他画面。収支記録・収支履歴でカテゴリを選択する際のマスタ。 |

---

## 2. 画面概要

- **目的**: 収支の分類（費目・収入の種類）を表すカテゴリマスタ（CATEGORY）を登録・編集・削除する。種別（支出/収入/振替）ごとに一覧表示し、親子階層（PARENT_ID）を設定できる。
- **業務上の位置付け**: カテゴリマスタの一覧・追加・更新・削除画面。ツリービューとフラットビューを切替可能。
- **想定利用シナリオ**: 支出カテゴリを「食費」「交通費」などで登録し、親カテゴリでグループ化する。種別タブで支出/収入/振替を切り替えて編集する。

---

## 3. UI構成

### 3.1 画面レイアウト

| エリア | 内容 |
|--------|------|
| ヘッダー | タイトル「カテゴリー」、データ最新化、追加ボタン、削除モード切替 |
| 検索エリア | 種別タブ（支出・収入・振替）、ツリービュー/フラットビュー切替ボタン |
| 一覧エリア | category-table（アイコン、カテゴリー名、親カテゴリー、削除。フラット時はドラッグハンドルあり） |
| 詳細エリア | 追加時のみモーダル（カテゴリー名、種別、親カテゴリー、色・アイコン） |
| フッター | 戻るボタン |

### 3.2 入力項目定義（追加モーダル）

| 項目名 | DB項目 | 型 | 必須 | 制約 | 備考 |
|--------|--------|-----|------|------|------|
| カテゴリー名 | CATEGORY.CATEGORY_NAME | 文字列 | ○ | — | 例: 食費, 給与 |
| 種別 | CATEGORY.TYPE | 列挙 | ○ | income / expense / transfer | タブと連動。追加時は選択中タブが初期値 |
| 親カテゴリー | CATEGORY.PARENT_ID | 文字列 | — | 同種別内の他 ID または空 | 空でルート。自分及び子孫は選択不可（循環防止） |
| 色 | CATEGORY.COLOR | 文字列 | — | #rrggbb 推奨 | カラーピッカー |
| アイコンパス | CATEGORY.ICON_PATH | 文字列 | — | — | ピッカーで選択 |

一覧行: カテゴリー名（contentEditable）、親カテゴリー（select）、アイコン（クリックで色・アイコン変更）、削除（削除モード時）。

---

## 4. 操作仕様（イベント仕様）

| 操作 | 条件 | 処理内容 | 備考 |
|------|------|----------|------|
| 種別タブ | — | 選択種別を切り替え、一覧を再描画（同種別のみ表示） | |
| ツリービュー/フラットビュー | — | categoryTreeViewMode をトグル。ツリー時は階層表示・ドラッグなし。フラット時は SORT_ORDER 順・ドラッグ可 | |
| 追加ボタン | — | モーダルを開く。種別＝現在タブ、親＝未選択で初期化 | |
| モーダル 登録 | カテゴリー名が空でない | 新規 CATEGORY 行（ID=最大+1, TYPE, PARENT_ID, SORT_ORDER=同種別内最大+1）を追加。saveCategoryCsvOnly → モーダル閉じ、一覧再描画 | |
| カテゴリー名セル編集 | — | 空なら deleteCategoryRow。否则 saveCategoryNameFromCell（バージョンチェック → 永続化） | |
| 親カテゴリー select change | — | saveParentFromSelect（バージョンチェック → PARENT_ID 更新 → 永続化） | |
| アイコンクリック | — | カラーピッカー。バージョンチェック → COLOR, ICON_PATH 更新 → 永続化 | |
| ドラッグ並び替え | フラット時、同種別内 | moveCategoryOrder: SORT_ORDER 再採番 → 永続化 | |
| 行削除 | 削除モード ON | deleteCategoryRow: 該当行削除 → saveCategoryCsvOnly | |

---

## 5. 業務ルール

- **種別ごとに表示**: 一覧は選択中の種別（支出/収入/振替）に一致する行のみ。並びは同種別内の SORT_ORDER 昇順。
- **親子関係の循環禁止**: 親カテゴリー選択時、自分自身およびその子孫は候補から除外する（getDescendantIds + 自身 ID）。
- **ツリー表示時**: ルート（PARENT_ID が空または存在しない）から子を再帰的に表示。同階層の並びは SORT_ORDER。ドラッグ並び替えはフラット時のみ。
- **楽観的ロック**: 更新・削除前に CATEGORY の VERSION をチェック。

---

## 6. データ連携

### 6.1 API仕様

| メソッド | パス | 概要 |
|----------|------|------|
| GET | /api/data/CATEGORY.csv | カテゴリ一覧取得 |
| POST | /api/data/CATEGORY.csv | カテゴリ CSV 保存（saveCategoryCsvOnly。行あり時のみ） |

### 6.2 DB定義（CSV 対応）

| 種別 | テーブル（ファイル） | 備考 |
|------|----------------------|------|
| 使用テーブル | CATEGORY | 全件取得。種別・SORT_ORDER でソート。表示は種別フィルタ |
| 参照テーブル | CATEGORY | 同上。親選択は同種別かつ自分・子孫を除外 |
| 更新対象 | CATEGORY | 追加・更新（名前・親・色・アイコン・SORT_ORDER）・削除 |

---

## 7. 権限制御

- カテゴリマスタは**ユーザー共通**（USER_ID による制限なし）。ログイン済みユーザーは全員が一覧の編集・追加・削除が可能。

---

## 8. バリデーション仕様

| 種別 | 内容 |
|------|------|
| 必須チェック | カテゴリー名: 追加時は空不可。一覧で空にした場合は削除扱い |
| 業務チェック | 親カテゴリー: 自分自身および子孫は選択不可（循環防止） |

---

## 9. エラー仕様

| 項目 | 内容 |
|------|------|
| 表示位置 | バージョン競合: alert |
| メッセージ内容 | getVersionConflictMessage と同様 |
| HTTP ステータス | POST が 200 以外のとき saveCsvViaApi が throw |

---

## 10. 非機能要件

| 項目 | 内容 |
|------|------|
| レスポンス目標 | 特になし |
| 同時接続数想定 | 特になし |
| ログ出力内容 | 特になし |
