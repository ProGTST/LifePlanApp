# 収支履歴画面 仕様書

## 1. 画面基本情報

| 項目 | 内容 |
|------|------|
| 画面ID | transaction-history（メイン）、transaction-history-calendar（月カレンダー）、transaction-history-weekly（週カレンダー） |
| 画面名 | 収支履歴（タブ: 一覧 / 週カレンダー / 月カレンダー） |
| URL | N/A（SPA。ビューIDで切替。カレンダーはサイドバー「カレンダー」で transaction-history-calendar を開く） |
| 対象ユーザー | ログイン済みの一般ユーザー。参照可能な勘定に紐づく取引のみ表示。 |
| 関連画面 | **遷移元**: フッター「収支履歴」、サイドバー「収支履歴」、カレンダー画面内「一覧で表示」等。<br>**遷移先**: 収支記録（行クリックで編集）、カレンダー日付クリックで検索条件に日付をセットして一覧表示。 |

---

## 2. 画面概要

- **目的**: 収支（予定・実績）の一覧表示、週単位・月単位のカレンダー表示を行い、検索条件で絞り込む。行クリックで収支記録画面に遷移し編集できる。
- **業務上の位置付け**: 収支データの参照・検索・分析の入口。カレンダーは年月ピッカーで選択した年月に取引日が含まれるデータのみ表示する。
- **想定利用シナリオ**: 一覧で期間・カテゴリ・勘定・タグで絞り込み、該当取引を確認する。月カレンダーで月ごとの収支を俯瞰し、日付クリックでその日の取引を一覧で見る。

---

## 3. UI構成

### 3.1 画面レイアウト

| エリア | 内容 |
|--------|------|
| ヘッダー | タイトル（収支履歴 / カレンダー）、データ最新化、検索条件リセット（一覧・カレンダー表示時） |
| 検索エリア | 予定/実績、取引種別、日付範囲、カテゴリー、タグ、勘定項目、金額範囲、フリーテキスト。検索条件は「一覧」「週カレンダー」「月カレンダー」で別保持（filterStateHistory / filterStateCalendar）。スケジュール画面とは別（filterStateSchedule） |
| 一覧エリア | **一覧タブ**: テーブル（取引日、種別、予定/実績、カテゴリ、タグ、勘定、項目名、金額、メモ等）。**週カレンダー**: 選択月の週一覧と週ごとの取引リスト。**月カレンダー**: グリッド（日付セルに件数・金額サマリ）、フッターに月合計 |
| 詳細エリア | 行クリックで収支記録画面へ遷移（編集または閲覧） |
| フッター | ホーム、カレンダー、スケジュール、収支履歴、収支記録、分析、メニュー、設定、戻る |

### 3.2 入力項目定義（検索条件）

| 項目名 | 対応フィルタ | 型 | 必須 | 制約 | 備考 |
|--------|--------------|-----|------|------|------|
| 予定/実績 | filterStatus | 複数選択 | — | plan, actual | チェックボックス等 |
| 取引種別 | filterType | 複数選択 | — | income, expense, transfer | 同上 |
| 日付 From | filterDateFrom | 日付 | — | YYYY-MM-DD | 実績は TRANDATE_FROM、予定は範囲で比較 |
| 日付 To | filterDateTo | 日付 | — | YYYY-MM-DD | 同上 |
| カテゴリー | filterCategoryIds | 複数選択 | — | CATEGORY.ID | モーダル等で選択 |
| タグ | filterTagIds | 複数選択 | — | TAG.ID | 同上 |
| 勘定項目 | filterAccountIds | 複数選択 | — | ACCOUNT.ID | 同上 |
| 金額 Min | filterAmountMin | 数値 | — | — | AMOUNT 以上 |
| 金額 Max | filterAmountMax | 数値 | — | — | AMOUNT 以下 |
| フリーテキスト | filterFreeText | 文字列 | — | — | NAME / MEMO の部分一致（大文字小文字区別なし） |

※ 一覧・カレンダーで表示する元データは、削除フラグ（DLT_FLG≠1）・勘定の参照権限で絞ったうえ、上記検索条件および月カレンダーでは選択年月（取引日がその月に含まれるもの）でさらに絞る。

---

## 4. 操作仕様（イベント仕様）

| 操作 | 条件 | 処理内容 | 備考 |
|------|------|----------|------|
| タブ切替（一覧/週/月） | — | 該当タブのパネルを表示。検索条件はカレンダー用（filterStateCalendar）で共通。週/月では loadAndShowCalendar または一覧では loadAndShow | |
| 検索条件変更 | — | 該当 filterState を更新し、一覧またはカレンダーを再描画。registerFilterChangeCallback で他画面のコールバックも実行 | |
| 検索条件リセット | — | 日付・金額・フリーテキスト等をクリアし、条件をデフォルトに戻して再描画 | |
| 一覧行クリック | — | 該当取引の ID を setTransactionEntryEditId にセットし、収支記録画面へ遷移。閲覧専用は setTransactionEntryViewOnly(true) | |
| 月カレンダー日付クリック | — | setFilterDateFromTo でその日を開始・終了にセットし、一覧タブで表示（または一覧に切り替え） | |
| 年月ピッカー変更 | 月カレンダー/週カレンダー | 表示月を変更。月カレンダーでは getFilteredTransactionListForCalendar(ym) でその年月に含まれる取引のみ表示 | |
| データ最新化 | — | triggerRefreshFromCsv → loadTransactionData(true) のうえで現在ビューを再描画 | |

---

## 5. 業務ルール

- **表示対象の取引**: (1) DLT_FLG が "1" でない、(2) ACCOUNT_ID_IN または ACCOUNT_ID_OUT が「参照可能な勘定」に含まれる、(3) 検索条件（予定/実績・種別・日付・カテゴリ・タグ・勘定・金額・フリーテキスト）を満たす。月カレンダーはさらに (4) 取引日（開始・終了）が選択年月に含まれるもののみ。
- **検索条件の保持**: 収支履歴一覧用（filterStateHistory）とカレンダー用（filterStateCalendar）は別。スケジュール用（filterStateSchedule）も別。タブ切替時はカレンダー用を表示。
- **ソート**: 一覧は TRANDATE_FROM 降順、TRANDATE_TO 降順、REGIST_DATETIME 降順。
- **楽観的ロック**: 本画面は参照が主。更新は収支記録画面で行い、バージョンチェックはそちらで実施。

---

## 6. データ連携

### 6.1 API仕様

| メソッド | パス | 概要 |
|----------|------|------|
| GET | /api/data/TRANSACTION.csv | 取引一覧取得（loadTransactionData 内） |
| GET | /api/data/CATEGORY.csv | カテゴリ名表示用 |
| GET | /api/data/ACCOUNT.csv | 勘定名表示用 |
| GET | /api/data/ACCOUNT_PERMISSION.csv | 参照可能勘定の判定 |
| GET | /api/data/TAG.csv | タグ名表示用 |
| GET | /api/data/TAG_MANAGEMENT.csv | 取引-タグ対応 |
| GET | /api/data/TRANSACTION_MANAGEMENT.csv | 予定-実績紐付け表示用 |

※ 本画面では CSV の更新は行わない（参照のみ）。

### 6.2 DB定義（CSV 対応）

| 種別 | テーブル（ファイル） | 備考 |
|------|----------------------|------|
| 使用テーブル | TRANSACTION, CATEGORY, ACCOUNT, ACCOUNT_PERMISSION, TAG, TAG_MANAGEMENT, TRANSACTION_MANAGEMENT | 表示・検索・集計に使用 |
| 参照テーブル | 同上 | 更新対象なし |
| 更新対象 | なし | 収支記録画面で TRANSACTION 等を更新 |

---

## 7. 権限制御

- **勘定項目ごとの参照制御**: 表示される取引は「自分の勘定」または「ACCOUNT_PERMISSION で自分に view/edit が付与された勘定」に紐づくもののみ。他ユーザー勘定で権限のない取引は一覧・カレンダーに表示されない。
- **行ごとの権限表示**: 権限付与された勘定に紐づく行は行背景で「参照」「編集」を区別表示（getRowPermissionType）。編集可否は収支記録画面で制御。

---

## 8. バリデーション仕様

- 検索条件の日付・金額は入力されていれば数値・日付として解釈し、範囲チェックでフィルタに使用。不正値は無視または未入力扱い。

---

## 9. エラー仕様

| 項目 | 内容 |
|------|------|
| 表示位置 | CSV 取得失敗時は空一覧で表示。API エラーは未ハンドリングの場合はコンソール |
| メッセージ内容 | 特になし（本画面は保存を行わないためバージョン競合は発生しない） |
| HTTP ステータス | GET が 200 以外のとき fetchCsv は空を返す想定 |

---

## 10. 非機能要件

| 項目 | 内容 |
|------|------|
| レスポンス目標 | 特になし。大量データ時は仮想スクロール等の検討余地あり |
| 同時接続数想定 | 特になし |
| ログ出力内容 | 特になし |
