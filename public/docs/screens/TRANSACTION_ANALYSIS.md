# 収支分析画面 仕様書

## 1. 画面基本情報

| 項目 | 内容 |
|------|------|
| 画面ID | transaction-analysis |
| 画面名 | 収支分析 |
| URL | N/A（SPA。ビューID: `transaction-analysis`） |
| 対象ユーザー | ログイン済みの一般ユーザー。資金繰り・種別・カテゴリーは個人の勘定の取引のみ。勘定項目ごとは参照可能な勘定の取引を表示。 |
| 関連画面 | **遷移元**: フッター「分析」、サイドバー「収支分析」。**遷移先**: 他画面（収支記録・収支履歴等）。 |

---

## 2. 画面概要

- **目的**: 予定取引の資金繰り（運転資金・充足率）と、今年の実績取引を収支種別・カテゴリー・勘定項目ごとにグラフ・表で可視化する。
- **業務上の位置付け**: 収支データの分析ビュー。参照のみでデータの更新は行わない。
- **想定利用シナリオ**: 予定の資金繰りを月単位で確認し、実績の月別変動・カテゴリー別割合・勘定別変動を把握する。

---

## 3. UI構成（表示順）

上から順に以下を表示する。

### 3.1 予定取引の資金繰りグラフ

| 項目 | 内容 |
|------|------|
| 説明 | 支出と収入の予定から残高を計算し、運転資金が予定の支出を賄えているかをグラフ化する。同一日に予定収入と予定支出が発生する場合は、**収入を先に計算**する。 |
| 対象データ | 未削除（DLT_FLG≠1）、かつ、**個人の勘定項目**の取引、かつ、**計画中**（完了・中止でない）、かつ**振替以外**の予定取引。 |
| グラフ | **運転資金**を折れ線グラフ、**予定支出**を棒グラフ。 |
| 横軸 | 月単位（最初の予定取引の月～最後の予定取引の月）。 |
| 縦軸 | 金額。 |

### 3.2 予定取引の資金繰り表

| 項目 | 内容 |
|------|------|
| 説明 | 支出と収入の予定から残高を計算し、運転資金が予定の支出を賄えているかの充足率を表で表示。同一日は収入を先に計算。 |
| 対象データ | 上記「予定取引の資金繰りグラフ」と同じ。 |
| 列 | 月単位（最初の予定取引の月～最後の予定取引の月）。 |
| 項目（行） | 予定収入、予定支出、予定残高、運転資金、充足率(%)。 |

### 3.3 収支種別ごとの変動グラフ

| 種別 | 対象データ | グラフ | 横軸 | 縦軸 |
|------|------------|--------|------|------|
| 支出 | 未削除、個人の勘定、**今年の支出**の実績取引 | 棒グラフ | 1月～12月 | 金額 |
| 収入 | 未削除、個人の勘定、**今年の収入**の実績取引 | 棒グラフ | 1月～12月 | 金額 |
| 振替 | 未削除、個人の勘定、**今年の振替**の実績取引 | 棒グラフ | 1月～12月 | 金額 |

### 3.4 収支種別ごとの集計表

| 項目 | 内容 |
|------|------|
| 対象データ | 未削除、個人の勘定、**今年の実績取引**（収入・支出・振替を月別集計）。 |
| 列 | 1月～12月。 |
| 項目（行） | 収入、支出、振替、残高、運転資金。 |

### 3.5 カテゴリーごとの推移グラフ

| 種別 | 対象データ | グラフ | 横軸 | 縦軸 |
|------|------------|--------|------|------|
| 支出 | 未削除、個人の勘定、今年の**支出カテゴリー**の実績取引 | 支出カテゴリーごとの折れ線グラフ | 1月～12月 | 金額 |
| 収入 | 未削除、個人の勘定、今年の**収入カテゴリー**の実績取引 | 収入カテゴリーごとの折れ線グラフ | 1月～12月 | 金額 |
| 振替 | 未削除、個人の勘定、今年の**振替カテゴリー**の実績取引 | 振替カテゴリーごとの折れ線グラフ | 1月～12月 | 金額 |

### 3.6 カテゴリーごとの集計表

タブで「支出」「収入」「振替」を切替え、各収支種別ごとに月別金額を表で表示する。

| 種別 | 対象データ | 列 | 項目（行） |
|------|------------|-----|------------|
| 支出 | 未削除、個人の勘定、今年の支出カテゴリーの実績取引 | 1月～12月 | 各支出カテゴリー名 |
| 収入 | 未削除、個人の勘定、今年の収入カテゴリーの実績取引 | 1月～12月 | 各収入カテゴリー名 |
| 振替 | 未削除、個人の勘定、今年の振替カテゴリーの実績取引 | 1月～12月 | 各振替カテゴリー名 |

### 3.7 カテゴリーごとの割合表

| 種別 | 表示内容 |
|------|----------|
| 支出 | アイコン、カテゴリー名、合計支出金額、全支出カテゴリーの合計に対する割合(%) |
| 収入 | アイコン、カテゴリー名、合計収入金額、全収入カテゴリーの合計に対する割合(%) |
| 振替 | アイコン、カテゴリー名、合計振替金額、全振替カテゴリーの合計に対する割合(%) |

対象データ: 未削除、個人の勘定、**今年の実績取引**（種別ごとに集計して割合を算出）。

### 3.8 勘定項目ごとの変動グラフ

| 項目 | 内容 |
|------|------|
| 対象データ | 未削除、**参照可能な勘定項目**の取引、**今年の実績取引**。 |
| グラフ | 棒グラフ（勘定項目ごとにデータセット）。 |
| 横軸 | 1月～12月。 |
| 縦軸 | 金額。 |

### 3.9 勘定項目ごとの集計表

| 項目 | 内容 |
|------|------|
| 対象データ | 上記「勘定項目ごとの変動グラフ」と同じ。 |
| 列 | 1月～12月。 |
| 項目（行） | 各勘定項目名。 |

---

## 4. 業務ルール（集計ロジック）

- **個人の勘定**: USER_ID が自分と一致する勘定（ACCOUNT）に紐づく取引のみ。権限付与された他ユーザー勘定は「収支種別・カテゴリー」の集計には含めない。
- **参照可能な勘定**: 自分の勘定 ＋ ACCOUNT_PERMISSION で view/edit が付与された勘定。勘定項目ごとのグラフ・表はこの範囲で集計。
- **今年**: 実績の対象日（TRANDATE_TO 優先、未設定時は TRANDATE_FROM）の年が現在年と一致する取引。
- **予定の資金繰り**: 予定発生日（getPlanOccurrenceDates）ごとに収入・支出を集計。同一日は収入を先に加算してから支出を減算。月ごとに予定収入・予定支出・予定残高を合計し、運転資金は月初運転資金＋当月予定収入－当月予定支出で累計。充足率は（月初運転資金＋当月予定収入）÷ 当月予定支出 × 100（予定支出が0のときは —）。

---

## 5. データ連携

- **参照のみ**: TRANSACTION, CATEGORY, ACCOUNT, ACCOUNT_PERMISSION, TAG, TRANSACTION_TAG, TRANSACTION_MANAGEMENT を loadTransactionData で取得。本画面では CSV の更新は行わない。
- **データ最新化**: メニューバー「データ最新化」で loadTransactionData(true) のうえで loadAndRender により全グラフ・表を再描画。

---

## 6. 権限制御

- 資金繰り・収支種別・カテゴリーの集計は「個人の勘定」の取引のみ（権限付与勘定は含めない）。
- 勘定項目ごとのグラフ・表は「参照可能な勘定」の取引を表示（他ユーザー勘定で権限付与されたものも含む）。

---

## 7. エラー・非機能

- CSV 取得失敗時は空のグラフ・表で表示。
- レスポンス・同時接続・ログは特記なし。
