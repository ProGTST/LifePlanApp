# カレンダー画面 仕様書

## 1. 画面基本情報

| 項目 | 内容 |
|------|------|
| 画面ID | transaction-history-calendar（月カレンダー）、transaction-history-weekly（週カレンダー）。収支履歴のタブのうち「週カレンダー」「月カレンダー」に対応。 |
| 画面名 | カレンダー（週カレンダー / 月カレンダー） |
| URL | N/A（SPA。ビューID: `transaction-history-calendar` または `transaction-history-weekly`。フッター「カレンダー」またはサイドバー「カレンダー」で開く） |
| 対象ユーザー | ログイン済みの一般ユーザー。参照可能な勘定に紐づく取引のみ表示。 |
| 関連画面 | **遷移元**: フッター「カレンダー」、サイドバー「カレンダー」、収支履歴で「週カレンダー」「月カレンダー」タブを選択。<br>**遷移先**: 日付クリックで収支履歴画面へ遷移し、検索条件の開始日・終了日にその日を設定して一覧を表示。収支記録（一覧から行クリック）、他画面へ。 |

---

## 2. 画面概要

- **目的**: 収支（予定・実績）を週単位・月単位のカレンダーで表示し、日付ごとの件数・金額サマリや月合計を確認する。選択年月に取引日が含まれるデータのみを表示する。
- **業務上の位置付け**: 収支履歴の一つの表示形式。検索条件は「収支履歴一覧」とは別の filterStateCalendar で保持し、週・月タブで共通利用する。
- **想定利用シナリオ**: 月カレンダーでその月の収支を日別に俯瞰し、日付をクリックしてその日の取引を一覧で確認する。週カレンダーで週ごとの取引リストを確認する。グラフで予定・実績の収支を日別・カテゴリ別に把握する。

---

## 3. UI構成

### 3.1 画面レイアウト

| エリア | 内容 |
|--------|------|
| ヘッダー | タイトル「カレンダー」、データ最新化、検索条件リセット |
| 検索エリア | 収支履歴と同様（予定/実績、種別、日付、カテゴリ、タグ、勘定、金額、フリーテキスト）。filterStateCalendar で保持。週・月タブで共通。 |
| タブ | 「一覧」「週カレンダー」「月カレンダー」。カレンダー表示時は週または月タブがアクティブ。 |
| 一覧エリア | **月カレンダー**: 年月ピッカー（transaction-history-calendar-ym）、前月・次月ボタン、カレンダーグリッド（日付セルに予定件数・実績件数・収入/支出/振替の金額サマリ）、フッターに月合計（予定収入・予定支出・残高、実績収入・実績支出・残高）。**週カレンダー**: 年月ピッカー、選択月の週一覧、週ごとの取引リスト。各週ブロックのフッターは収入・支出・残高を表示。 |
| グラフ | 選択年月に応じた日別棒グラフ・カテゴリ別円グラフ（予定収入・実績収入・予定支出・実績支出）。 |
| フッター | 共通ナビ。「一覧で表示」で収支履歴一覧へ。 |

### 3.2 入力項目定義（検索条件）

収支履歴画面の検索条件と同様（filterStatus, filterType, filterDateFrom, filterDateTo, filterCategoryIds, filterTagIds, filterAccountIds, filterAmountMin, filterAmountMax, filterFreeText）。カレンダー用は filterStateCalendar。

### 3.3 月カレンダー：日付ブロック内の表示仕様

各日付セル（日付ブロック）には、日付番号の下に以下のサマリを**上からこの順**で表示する。該当する取引がない、または金額が 0 の項目は表示しない。

| 順番 | 表示内容 | 表示条件 | 表示例 |
|------|----------|----------|--------|
| 1 | 予定の件数 | その日に予定の「対象日」が1件以上ある（頻度に応じた集計ルールで対象日にカウント） | 「予」＋「○件」 |
| 2 | 実績の件数 | その日に実績が1件以上ある（TRANDATE_TO ＝ その日。未設定時は TRANDATE_FROM） | 「実」＋「○件」 |
| 3 | 収入の金額 | その日に紐づく収入の合計が 1 円以上 | 「収」＋金額（桁区切り） |
| 4 | 支出の金額 | その日に紐づく支出の合計が 1 円以上 | 「支」＋金額（桁区切り） |
| 5 | 振替の金額 | その日に紐づく振替の合計が 1 円以上 | 「振」＋金額（桁区切り） |

- **予定の対象**: その日が TRANDATE_FROM～TRANDATE_TO に含まれるデータを対象とする。件数・金額は頻度（FREQUENCY）・間隔（INTERVAL）・繰り返し（CYCLE_UNIT）に従い「対象日」のみで集計する（getPlanOccurrenceDates / getCalendarDaySummary）。
- **予定の集計ルール（頻度別）**  
  - **① 頻度が1日（day）**: 件数は TRANDATE_FROM～TRANDATE_TO の間の日をカウント対象（その日が範囲内なら＋1）。収入・支出・振替の金額は **TRANDATE_TO の日**を集計対象とする。  
  - **② 頻度が日ごと（daily）**: TRANDATE_FROM を起算日とし、間隔で指定された日を対象とする。件数は対象日にカウント、金額は対象日に集計。  
  - **③ 頻度が週ごと（weekly）**: TRANDATE_FROM を含む週から起算し、間隔で指定された週を対象。対象週のうち繰り返し（CYCLE_UNIT）で指定した曜日のみ対象日。件数・金額は対象日に集計。  
  - **④ 頻度が月ごと（monthly）**: TRANDATE_FROM を含む月から起算し、間隔で指定された月を対象。対象月のうち繰り返しで指定した日のみ対象日。件数・金額は対象日に集計。  
  - **⑤ 頻度が年ごと（yearly）**: TRANDATE_FROM を含む年から起算し、間隔で指定された年を対象。対象年のうち繰り返しで指定した日付（MMDD）のみ対象日。件数・金額は対象日に集計。  
  いずれも日付の範囲は TRANDATE_FROM～TRANDATE_TO の間とする。
- **実績**: TRANDATE_TO ＝ その日の行を件数・金額に含める。TRANDATE_TO が未設定の場合は TRANDATE_FROM を対象日とする。
- **空の日**: その日に該当する予定・実績がなく、かつ収入・支出・振替の合計がすべて 0 の場合は、**日付番号のみ**表示し、サマリ行は出さない。
- **クリック時**: 収支履歴画面へ遷移し、検索条件の日付欄（開始日・終了日）にその日を設定して表示データを抽出する。カレンダー画面内ではデータの抽出・一覧表示は行わない。

---

### 3.4 週カレンダー：週ブロックの表示仕様

選択月の週（月曜～日曜の範囲で区切った週）ごとに**週ブロック**を1つ表示する。各週ブロックは次の構成とする。

| 構成 | 内容 |
|------|------|
| **タイトル** | 「○週目」およびその週の日付範囲（例: 「2月10日～2月16日」）。現在週の場合は視覚的に強調する。 |
| **取引リスト** | その週の日付範囲に**発生日が含まれる**取引を、発生日ごとにグループ化して表示する。 |
| **フッター** | その週の予定・実績それぞれについて「収入」「支出」「残高」を表示する。 |

**取引の表示対象**

- 実績: その週のいずれかの日が TRANDATE_TO と一致する取引（TRANDATE_TO 未設定時は TRANDATE_FROM）。
- 予定: その週のいずれかの日が**対象日**（頻度・間隔・繰り返しに従い算出した発生日）に含まれる取引。対象日の算出は 3.3 の予定集計ルールに同じ（getPlanOccurrenceDates / getTransactionsInRange）。

**リスト内の表示順・表示項目**

- 日付グループは日付の昇順。同一日付内の取引は一覧の並び順で表示。
- 各取引は次の項目を表示する: 収支種別アイコン（収/支/振）、カテゴリアイコン、名称、金額（その発生日で集計する金額。予定は対象日に対応する金額を表示）。

**フッターの集計**

- 「予定」行: その週に表示した予定取引の収入合計・支出合計・残高（収入－支出）。
- 「実績」行: その週に表示した実績取引の収入合計・支出合計・残高。
- 振替は収入・支出のいずれにも含めず、表示上は金額のみリストに出す。フッターの残高は「収入－支出」で算出する。

**クリック時**

- リスト内の取引行をクリックすると、該当取引の収支記録画面へ遷移する。参照権限のみの場合は閲覧のみで開く。

---

### 3.5 表示データの抽出条件（検索条件欄以外）

- **未削除のみ**: TRANSACTION の DLT_FLG が "1" でない行のみ。
- **勘定の参照権限**: ACCOUNT_ID_IN または ACCOUNT_ID_OUT が、自分の勘定または ACCOUNT_PERMISSION で付与された勘定に含まれる取引のみ。
- **日付欄は使用しない**: カレンダーでは検索条件の日付欄（開始日～終了日）では表示データを抽出しない。選択年月のみで抽出する。
- **選択年月（月・週カレンダー）**: 年月ピッカーで選択した YYYY-MM に対し、**取引日（開始・終了）がその月に含まれる取引**のみを表示対象とする。実績は TRANDATE_TO（未設定時は TRANDATE_FROM）の年月が一致するもの、予定は TRANDATE_FROM～TRANDATE_TO が選択月のいずれかの日と重なるもの。`getFilteredTransactionListForCalendar(ym)` に年月を渡して絞り込む。

---

## 4. 操作仕様（イベント仕様）

| 操作 | 条件 | 処理内容 | 備考 |
|------|------|----------|------|
| タブ切替（週/月） | — | 週カレンダーまたは月カレンダーのパネルを表示。selectedCalendarYM に従い年月ピッカー・グリッド・グラフを描画。 | 検索条件は filterStateCalendar で共通 |
| 年月ピッカー変更 | — | selectedCalendarYM を更新し、月カレンダーまたは週カレンダーを再描画。getFilteredTransactionListForCalendar(ym) でその年月の取引のみ使用。グラフも当該年月で再描画。 | |
| 前月・次月ボタン | — | 年月を1つ前/後にし、上記と同様に再描画。 | |
| 月カレンダー日付クリック | — | 収支履歴用の検索条件にその日を開始日・終了日に設定し、収支履歴画面へ遷移する。収支履歴画面でその日で絞り込んだ一覧を表示する。 | setHistoryFilterDateFromTo → showMainView("transaction-history") |
| 週カレンダー内の取引クリック | — | 該当取引の ID を setTransactionEntryEditId にセットし、収支記録画面へ遷移。 | 実装で行クリック時に遷移する場合 |
| 検索条件変更 | — | filterStateCalendar を更新し、カレンダー・グラフを再描画。 | |
| 検索条件リセット | — | 条件をデフォルトに戻して再描画。 | |
| データ最新化 | — | loadTransactionData(true) のうえで loadAndShowCalendar によりカレンダー・グラフを再描画。 | |

---

## 5. 業務ルール

- **表示対象**: (1) 未削除（DLT_FLG≠1）、(2) 参照可能な勘定に紐づく取引、(3) 検索条件（filterStateCalendar）のうち**日付欄を除く**条件を満たす、(4) **取引日が選択年月に含まれる**（実績は TRANDATE_TO（未設定時は TRANDATE_FROM）の年月一致、予定は範囲が選択月と重なる）。カレンダーでは日付欄（開始日～終了日）で抽出しない。
- **日付セルの集計**: 月カレンダーの各日は、その日付に該当する取引のみを集計。表示項目の順序・ラベル・表示条件・空の日の扱い・クリック時の動作は **3.3 月カレンダー：日付ブロック内の表示仕様** を参照。実績は TRANDATE_TO＝その日で集計（未設定時は TRANDATE_FROM）。予定は頻度・間隔・繰り返しに従い「対象日」を算出し、対象日に件数・金額を集計する（getPlanOccurrenceDates / getCalendarDaySummary）。
- **月合計**: 選択月の予定収入・予定支出・実績収入・実績支出をフッターに表示（getCalendarMonthTotals）。
- **週カレンダー**: 選択月の週（月曜～日曜の範囲）ごとにブロックを表示し、その週の日付範囲に**対象日が含まれる**取引をリスト表示。getTransactionsInRange で週範囲内に発生日がある予定・実績を取得する。

---

## 6. データ連携

### 6.1 API仕様

収支履歴画面と同様。GET /api/data/TRANSACTION.csv, CATEGORY.csv, ACCOUNT.csv, ACCOUNT_PERMISSION.csv, TAG.csv, TRANSACTION_TAG.csv 等。本画面では CSV の更新は行わない（参照のみ）。

### 6.2 DB定義（CSV 対応）

| 種別 | テーブル（ファイル） | 備考 |
|------|----------------------|------|
| 使用テーブル | TRANSACTION, CATEGORY, ACCOUNT, ACCOUNT_PERMISSION, TAG, TRANSACTION_TAG 等 | 表示・集計・グラフ用。更新なし |
| 参照テーブル | 同上 | 更新対象なし |
| 更新対象 | なし | 収支記録画面で更新 |

---

## 7. 権限制御

- 収支履歴と同様。参照可能な勘定に紐づく取引のみ表示。勘定の参照権限は ACCOUNT_PERMISSION で制御。

---

## 8. バリデーション仕様

- 検索条件の日付・金額は入力されていればフィルタに使用。年月ピッカーは YYYY-MM 形式。不正値は無視または未選択扱い。

---

## 9. エラー仕様

| 項目 | 内容 |
|------|------|
| 表示位置 | CSV 取得失敗時は空のグリッド・グラフで表示。バージョン競合は本画面では発生しない（参照のみ）。 |
| メッセージ内容 | 特になし |
| HTTP ステータス | GET が 200 以外のとき fetchCsv は空を返す想定 |

---

## 10. 非機能要件

| 項目 | 内容 |
|------|------|
| レスポンス目標 | 特になし |
| 同時接続数想定 | 特になし |
| ログ出力内容 | 特になし |
