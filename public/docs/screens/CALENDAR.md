# カレンダー画面 仕様書

## 1. 画面基本情報

| 項目 | 内容 |
|------|------|
| 画面ID | transaction-history-calendar（月カレンダー）、transaction-history-weekly（週カレンダー）。収支履歴のタブのうち「週カレンダー」「月カレンダー」に対応。 |
| 画面名 | カレンダー（週カレンダー / 月カレンダー） |
| URL | N/A（SPA。ビューID: `transaction-history-calendar` または `transaction-history-weekly`。フッター「カレンダー」またはサイドバー「カレンダー」で開く） |
| 対象ユーザー | ログイン済みの一般ユーザー。参照可能な勘定に紐づく取引のみ表示。 |
| 関連画面 | **遷移元**: フッター「カレンダー」、サイドバー「カレンダー」、収支履歴で「週カレンダー」「月カレンダー」タブを選択。<br>**遷移先**: 日付クリックで検索条件に日付をセットし一覧タブで表示。収支記録（一覧から行クリック）、他画面へ。 |

---

## 2. 画面概要

- **目的**: 収支（予定・実績）を週単位・月単位のカレンダーで表示し、日付ごとの件数・金額サマリや月合計を確認する。選択年月に取引日が含まれるデータのみを表示する。
- **業務上の位置付け**: 収支履歴の一つの表示形式。検索条件は「収支履歴一覧」とは別の filterStateCalendar で保持し、週・月タブで共通利用する。
- **想定利用シナリオ**: 月カレンダーでその月の収支を日別に俯瞰し、日付をクリックしてその日の取引を一覧で確認する。週カレンダーで週ごとの取引リストを確認する。グラフで予定・実績の収支を日別・カテゴリ別に把握する。

---

## 3. UI構成

### 3.1 画面レイアウト

| エリア | 内容 |
|--------|------|
| ヘッダー | タイトル「カレンダー」、データ最新化、検索条件リセット |
| 検索エリア | 収支履歴と同様（予定/実績、種別、日付、カテゴリ、タグ、勘定、金額、フリーテキスト）。filterStateCalendar で保持。週・月タブで共通。 |
| タブ | 「一覧」「週カレンダー」「月カレンダー」。カレンダー表示時は週または月タブがアクティブ。 |
| 一覧エリア | **月カレンダー**: 年月ピッカー（transaction-history-calendar-ym）、前月・次月ボタン、カレンダーグリッド（日付セルに予定件数・実績件数・収入/支出/振替の金額サマリ）、フッターに月合計（予定収入・予定支出・実績収入・実績支出）。**週カレンダー**: 年月ピッカー、選択月の週一覧、週ごとの取引リスト。 |
| グラフ | 選択年月に応じた日別棒グラフ・カテゴリ別円グラフ（予定収入・実績収入・予定支出・実績支出）。 |
| フッター | 共通ナビ。「一覧で表示」で収支履歴一覧へ。 |

### 3.2 入力項目定義（検索条件）

収支履歴画面の検索条件と同様（filterStatus, filterType, filterDateFrom, filterDateTo, filterCategoryIds, filterTagIds, filterAccountIds, filterAmountMin, filterAmountMax, filterFreeText）。カレンダー用は filterStateCalendar。

### 3.3 表示データの抽出条件（検索条件欄以外）

- **未削除のみ**: TRANSACTION の DLT_FLG が "1" でない行のみ。
- **勘定の参照権限**: ACCOUNT_ID_IN または ACCOUNT_ID_OUT が、自分の勘定または ACCOUNT_PERMISSION で付与された勘定に含まれる取引のみ。
- **選択年月（月・週カレンダー）**: 年月ピッカーで選択した YYYY-MM に対し、**取引日（開始・終了）がその月に含まれる取引**のみを表示対象とする。実績は TRANDATE_FROM の年月が一致するもの、予定は TRANDATE_FROM～TRANDATE_TO が選択月のいずれかの日と重なるもの。`getFilteredTransactionListForCalendar(ym)` に年月を渡して絞り込む。

---

## 4. 操作仕様（イベント仕様）

| 操作 | 条件 | 処理内容 | 備考 |
|------|------|----------|------|
| タブ切替（週/月） | — | 週カレンダーまたは月カレンダーのパネルを表示。selectedCalendarYM に従い年月ピッカー・グリッド・グラフを描画。 | 検索条件は filterStateCalendar で共通 |
| 年月ピッカー変更 | — | selectedCalendarYM を更新し、月カレンダーまたは週カレンダーを再描画。getFilteredTransactionListForCalendar(ym) でその年月の取引のみ使用。グラフも当該年月で再描画。 | |
| 前月・次月ボタン | — | 年月を1つ前/後にし、上記と同様に再描画。 | |
| 月カレンダー日付クリック | — | setFilterDateFromTo でその日を開始・終了にセットし、一覧タブに切り替えて収支履歴一覧を表示（その日の取引が検索条件で絞られた状態）。 | |
| 週カレンダー内の取引クリック | — | 該当取引の ID を setTransactionEntryEditId にセットし、収支記録画面へ遷移。 | 実装で行クリック時に遷移する場合 |
| 検索条件変更 | — | filterStateCalendar を更新し、カレンダー・グラフを再描画。 | |
| 検索条件リセット | — | 条件をデフォルトに戻して再描画。 | |
| データ最新化 | — | loadTransactionData(true) のうえで loadAndShowCalendar によりカレンダー・グラフを再描画。 | |

---

## 5. 業務ルール

- **表示対象**: (1) 未削除（DLT_FLG≠1）、(2) 参照可能な勘定に紐づく取引、(3) 検索条件（filterStateCalendar）を満たす、(4) **取引日が選択年月に含まれる**（実績は TRANDATE_FROM の年月一致、予定は範囲が選択月と重なる）。
- **日付セルの集計**: 月カレンダーの各日は、その日付に該当する取引のみを集計。実績は TRANDATE_FROM＝その日、予定は TRANDATE_FROM～TRANDATE_TO にその日が含まれるかで判定。予定の金額は「終了日がその日」のときのみ合計に含める（getCalendarDaySummary）。
- **月合計**: 選択月の予定収入・予定支出・実績収入・実績支出をフッターに表示（getCalendarMonthTotals）。
- **週カレンダー**: 選択月の週（月曜～日曜の範囲）ごとにブロックを表示し、各週の日付範囲に TRANDATE_FROM/TO が重なる取引をリスト表示。getTransactionsInRange に selectedCalendarYM を渡して年月で絞ったうえで週範囲でフィルタする。

---

## 6. データ連携

### 6.1 API仕様

収支履歴画面と同様。GET /api/data/TRANSACTION.csv, CATEGORY.csv, ACCOUNT.csv, ACCOUNT_PERMISSION.csv, TAG.csv, TAG_MANAGEMENT.csv 等。本画面では CSV の更新は行わない（参照のみ）。

### 6.2 DB定義（CSV 対応）

| 種別 | テーブル（ファイル） | 備考 |
|------|----------------------|------|
| 使用テーブル | TRANSACTION, CATEGORY, ACCOUNT, ACCOUNT_PERMISSION, TAG, TAG_MANAGEMENT 等 | 表示・集計・グラフ用。更新なし |
| 参照テーブル | 同上 | 更新対象なし |
| 更新対象 | なし | 収支記録画面で更新 |

---

## 7. 権限制御

- 収支履歴と同様。参照可能な勘定に紐づく取引のみ表示。勘定の参照権限は ACCOUNT_PERMISSION で制御。

---

## 8. バリデーション仕様

- 検索条件の日付・金額は入力されていればフィルタに使用。年月ピッカーは YYYY-MM 形式。不正値は無視または未選択扱い。

---

## 9. エラー仕様

| 項目 | 内容 |
|------|------|
| 表示位置 | CSV 取得失敗時は空のグリッド・グラフで表示。バージョン競合は本画面では発生しない（参照のみ）。 |
| メッセージ内容 | 特になし |
| HTTP ステータス | GET が 200 以外のとき fetchCsv は空を返す想定 |

---

## 10. 非機能要件

| 項目 | 内容 |
|------|------|
| レスポンス目標 | 特になし |
| 同時接続数想定 | 特になし |
| ログ出力内容 | 特になし |
